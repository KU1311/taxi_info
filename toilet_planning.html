<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>規劃建議 - 方便泊車的洗手間</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        html, body {
            margin: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #map {
            flex: 1;
            width: 100%;
            z-index: 1;
            position: relative;
        }

        .controls-container {
            position: relative;
            z-index: 10;
        }

        h2 {
            margin-bottom: 10px;
            text-align: center;
            color: white;
        }

        .dropdown-row {
            display: flex;
            justify-content: space-between;
            z-index: 20;
            background-color: #333;
            padding: 10px;
            box-sizing: border-box;
        }

        .dropdown-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 0 5px;
            box-sizing: border-box;
        }

        .dropdown-container label {
            margin-bottom: 5px;
            color: white;
            text-align: center;
        }

        select {
            background-color: #444;
            color: white;
            border: none;
            padding: 5px;
            border-radius: 3px;
            width: 100%;
            box-sizing: border-box;
        }

        .current-location-marker {
            background-color: rgba(73, 167, 223, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #333;
            color: white;
            padding: 10px;
        }

        .footer-content {
            display: flex;
            align-items: center;
        }

        .footer-icon {
            height: 3em;
            margin-right: 10px;
        }

        .whatsapp-button {
            background-color: #25D366;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            text-decoration: none;
            display: flex;
            align-items: center;
            margin-left: 40px;
        }
    </style>
</head>
<body style="background-color:#333;">
    <div class="controls-container">
        <div class="title-dropdown-container">
            <button class="back-button" onclick="window.history.back();">Back</button>
            <h2 style="color: white; margin: 0;">規劃建議 - 方便泊車的洗手間</h2>
        </div>  
        <div class="dropdown-row">
            <div class="dropdown-container">
                <label for="type-dropdown">顯示項目:</label>
                <select id="type-dropdown">
                    <option value="only toilets">Only Toilets</option>
                    <option value="1km invert">1km Invert</option>
                </select>
            </div>
        </div>
    </div>
    <div id="map"></div>
    <div class="footer">
        <div class="footer-content">
            <img src="https://raw.githubusercontent.com/KU1311/taxi_info/main/etaxi-icon.png" alt="eTaxi Icon" class="footer-icon">
            <h3>資料錯誤?提供意見? <br> 請聯絡客服</h3>
        </div>
        <a href="https://wa.me/85256600580" class="whatsapp-button">WhatsApp</a>
    </div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const defaultCoords = [22.305451, 114.169656];
        const defaultZoom = 12;

        const map = L.map('map').setView(defaultCoords, defaultZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            opacity: 0.7
        }).addTo(map);

        const csvUrl = 'https://raw.githubusercontent.com/KU1311/taxi_info/main/toilet_csv20250326.csv';
        const bufferGeoJsonUrl = 'https://raw.githubusercontent.com/KU1311/taxi_info/main/toilet_planning_1km_invert.geojson';
        let bufferLayer; 
        let markers = [];

        function createCustomIcon() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const size = 30;
            canvas.width = size;
            canvas.height = size;
            context.fillStyle = 'green'; // Default color
            context.beginPath();
            context.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
            context.fill();
            context.fillStyle = 'white';
            context.font = 'bold 10px Arial';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText('WC', size / 2, size / 2);
            const iconUrl = canvas.toDataURL();
            return L.icon({
                iconUrl: iconUrl,
                iconSize: [size, size],
                iconAnchor: [size / 2, size],
                popupAnchor: [0, -size]
            });
        }

        function setUserLocation(position) {
            const userCoords = [position.coords.latitude, position.coords.longitude];
            const userZoom = 16;
            map.setView(userCoords, userZoom);
            const userLocationMarker = L.divIcon({
                className: 'current-location-marker',
                iconSize: [50, 50]
            });
            L.marker(userCoords, { icon: userLocationMarker })
                .bindPopup(`<div class="current-location-label">你的位置</div>`)
                .addTo(map);
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(setUserLocation, function() {
                console.warn("Geolocation not allowed. Using default location.");
            });
        }

        fetch(csvUrl)
            .then(response => response.text())
            .then(csvData => {
                const rows = csvData.trim().split('\n');
                const headers = rows[0].split(',').map(header => header.replace('\r', '').replace('"', ''));
                const data = rows.slice(1).map(row => {
                    const values = row.split(',');
                    return headers.reduce((obj, header, i) => {
                        let value = String(values[i]).replace('\r', '');
                        obj[header] = value;
                        return obj;
                    }, {});
                });

                const features = data.map(row => {
                    const latitude = parseFloat(row['lat']);
                    const longitude = parseFloat(row['lng']);
                    return {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [longitude, latitude]
                        },
                        properties: {
                            id: row['id'],
                            openinghrs: row['openinghrs'],
                            name: row['name'],
                            lat: latitude,
                            lng: longitude
                        }
                    };
                });

                loadMarkers(features);
            });

        function loadMarkers(features) {
            features.forEach(feature => {
                const customIcon = createCustomIcon();
                const marker = L.marker([feature.properties.lat, feature.properties.lng], { icon: customIcon });
                const popupContent =
                    `<h3>${feature.properties.name}</h3>
                     <b>開放時間:</b> ${feature.properties.openinghrs}<br>
                     <button onclick="openGoogleMapsNavigation(${feature.properties.lat}, ${feature.properties.lng})">導航</button>`;
                marker.bindPopup(popupContent);
                marker.addTo(map);
                markers.push(marker);
            });
        }

        function loadBuffer() {
            fetch(bufferGeoJsonUrl)
                .then(response => response.json())
                .then(data => {
                    bufferLayer = L.geoJSON(data, {
                        style: {
                            color: 'blue',
                            weight: 2,
                            opacity: 0.5
                        }
                    }).addTo(map);
                });
        }

        const typeDropdown = document.getElementById('type-dropdown');
        typeDropdown.addEventListener('change', function() {
            const typeFilter = typeDropdown.value;
            if (typeFilter === '1km invert') {
                if (!bufferLayer) {
                    loadBuffer(); // Load the buffer if not already loaded
                } else {
                    map.addLayer(bufferLayer); // Show the buffer layer
                }
                markers.forEach(marker => marker.addTo(map)); // Show all toilet markers
            } else if (typeFilter === 'only toilets') {
                if (bufferLayer) {
                    map.removeLayer(bufferLayer); // Hide the buffer layer
                }
                markers.forEach(marker => marker.addTo(map)); // Show only toilet markers
            }
        });

        function openGoogleMapsNavigation(lat, lng) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>
