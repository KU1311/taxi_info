<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSV Data on OpenStreetMap</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    html {
	margin: 0;
	padding: 0;
	height: 100%;
	overflow: hidden;
    }
    body {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #333; /* Dark grey background */
            color: white; /* Change text color to white for better contrast */
        }
     button {
      display: flex;
      padding: 0.75rem;
      background-color: rgb(237, 28, 36 );
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }

	.current-location-marker {
	  background-color: rgba(73, 167, 223, 0.5);
	  border-radius: 50%;
	  width: 40px;
	  height: 40px;
	  display: flex;
	  justify-content: center;
	  align-items: center;
	  font-size: 12px;
	  font-weight: bold;
	  color: white;
	}
	
	.current-location-label {
	  padding: 4px 8px;
	  border-radius: 4px;
	  font-size: 12px;
	  font-weight: bold;
	}
	  
	.footer {
	    padding: 10px;
	    background-color: #444; /* Slightly lighter grey for footer */
	    width: 100%;
	    position: fixed; /* Use relative positioning */
            bottom: 0; /* Align to the bottom of the viewport */
            left: 0; /* Align to the left of the viewport */
	    z-index: 1000; /* Ensure the footer is above other elements */
	}
        .footer h3 {
            margin: 0; /* Remove default margin */
            padding-left: 10px; /* Add some padding to the left */
        }
	.whatsapp-button {
            background-color: #25D366;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            text-decoration: none;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
	.floating-title {
            position: absolute; /* Position relative to the map */
            top: 10px; /* Adjust as needed */
            left: 50%; /* Center horizontally */
            transform: translateX(-50%); /* Adjust for centering */
            background-color: #444; /* Dark grey background */
            color: white; /* White text */
            padding: 10px 20px; /* Some padding for aesthetics */
            border-radius: 5px; /* Rounded corners */
            font-size: 1.5rem; /* Size of the title */
            text-align: center; /* Center text inside the div */
            z-index: 1001; /* Ensure it's above the map */
        }
    .controls-container {
	  display: flex;
	  justify-content: space-around;
	  align-items: center;
	  background-color: #f1f1f1;
	  padding: 10px;
	  position: sticky;
	  top: 0;
	  z-index: 1000;
	}
	
	.dropdown-container {
	  display: flex;
	  align-items: center;
	}
	
	.dropdown-container label {
	  margin-right: 5px;
	}
	
	.dropdown-container select {
	  padding: 5px;
	  border-radius: 4px;
	  border: 1px solid #ccc;
	}
  </style>
</head>
<body>
  <div class="controls-container">
    <div class="dropdown-container">
      <label for="type-dropdown">Type:</label>
      <select id="type-dropdown">
        <option value="all">All</option>
      </select>
    </div>
    <div class="dropdown-container">
      <label for="time-dropdown">Time:</label>
      <select id="time-dropdown">
        <option value="all">All</option>
      </select>
    </div>
    <div class="dropdown-container">
      <label for="dangerous-dropdown">Dangerous:</label>
      <select id="dangerous-dropdown">
        <option value="all">All</option>
        <option value="true">True</option>
        <option value="false">False</option>
      </select>
    </div>
    <div class="dropdown-container">
      <label for="legal-dropdown">Legal:</label>
      <select id="legal-dropdown">
        <option value="all">All</option>
        <option value="true">True</option>
        <option value="false">False</option>
      </select>
    </div>
  </div>
  <div id="map" style="height: 80vh;"></div>
  <div class="floating-title">的士站/扎馬位置</div>
	<div class="footer">
	<h3>資料錯誤?提供意見? <br> 請聯絡客服</h3>
	<a href="https://wa.me/85256600580" class="whatsapp-button">WhatsApp</a>
	</div>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
	  let i = 1
        const map = L.map('map').setView([22.305451, 114.169656], 12);
	L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
	}).addTo(map);
	
	// Load the CSV data
    	const csvUrl = 'https://raw.githubusercontent.com/KU1311/taxi_info/main/taxipoints_csv_test1.csv';
	fetch(csvUrl)
	  .then(response => response.text())
	  .then(csvData => {
		const rows = csvData.trim().split('\n');
		const headers = rows[0].split(',').map(header => header.replace('\r', '').replace('"', ''));
		const data = rows.slice(1).map(row => {
			const values = row.split(',');
			return headers.reduce((obj, header, i) => {
				obj[header] = String(values[i]).replace('\r', '');
				return obj;
			}, {});
	    });
		console.log(data)
	    const features = data.map(row => {
		  const latitude = parseFloat(row['lat']);
		  const longitude = parseFloat(row['lng']);
		console.log("row: ",i)
		  // Log the coordinates
		  console.log(`Coordinates: (${latitude}, ${longitude})`);
		i+=1;
		  return {
		      type: 'Feature',
		      geometry: {
		        type: 'Point',
		        coordinates: [longitude, latitude]
		      },
		      properties: {
		        id: row['id'],
		        type: row['type'],
		        name: row['name'],
		        time: row['time'],
		        dangerous: row['dangerous'] === 'true',
		        legal: row['legal'] === 'true',
		        remarks: row['Remarks']
		      }
		  }
	    }).filter(feature => feature !== null); // Remove any null values
	
	    const featureLayer = L.geoJSON(features, {
	      onEachFeature: (feature, layer) => {
	        layer.bindPopup(`
	          <b>ID:</b> ${feature.properties.id}<br>
	          <b>Type:</b> ${feature.properties.type}<br>
	          <b>Name:</b> ${feature.properties.name}<br>
	          <b>Time:</b> ${feature.properties.time}<br>
	          <b>Dangerous:</b> ${feature.properties.dangerous ? 'True' : 'False'}<br>
	          <b>Legal:</b> ${feature.properties.legal ? 'True' : 'False'}<br>
	          <b>Remarks:</b> ${feature.properties.remarks}
	        `);
	      }
	    }).addTo(map);
	
	    // Populate the dropdowns
	    const typeOptions = new Set(['all']);
	    const timeOptions = new Set(['all']);
	    const dangerousOptions = new Set(['all', 'true', 'false']);
	    const legalOptions = new Set(['all', 'true', 'false']);
	
	    data.forEach(row => {
	      typeOptions.add(row.type);
	      timeOptions.add(row.time);
	    });
	
	    const typeDropdown = document.getElementById('type-dropdown');
	    const timeDropdown = document.getElementById('time-dropdown');
	    const dangerousDropdown = document.getElementById('dangerous-dropdown');
	    const legalDropdown = document.getElementById('legal-dropdown');
	
	    typeOptions.forEach(option => {
	      const optionElement = document.createElement('option');
	      optionElement.value = option;
	      optionElement.textContent = option;
	      typeDropdown.appendChild(optionElement);
	    });
	
	    timeOptions.forEach(option => {
	      const optionElement = document.createElement('option');
	      optionElement.value = option;
	      optionElement.textContent = option;
	      timeDropdown.appendChild(optionElement);
	    });
	
	    dangerousOptions.forEach(option => {
	      const optionElement = document.createElement('option');
	      optionElement.value = option;
	      optionElement.textContent = option;
	      dangerousDropdown.appendChild(optionElement);
	    });
	
	    legalOptions.forEach(option => {
	      const optionElement = document.createElement('option');
	      optionElement.value = option;
	      optionElement.textContent = option;
	      legalDropdown.appendChild(optionElement);
	    });
	
	    // Add event listeners for the dropdowns
	    typeDropdown.addEventListener('change', filterFeatures);
	    timeDropdown.addEventListener('change', filterFeatures);
	    dangerousDropdown.addEventListener('change', filterFeatures);
	    legalDropdown.addEventListener('change', filterFeatures);
	
	    function filterFeatures() {
	      const typeFilter = typeDropdown.value;
	      const timeFilter = timeDropdown.value;
	      const dangerousFilter = dangerousDropdown.value;
	      const legalFilter = legalDropdown.value;
	
	      featureLayer.eachLayer(layer => {
	        const feature = layer.feature;
	        let shouldShow = true;
	
	        if (typeFilter !== 'all' && feature.properties.type !== typeFilter) {
	          shouldShow = false;
	        }
	
	        if (timeFilter !== 'all' && feature.properties.time !== timeFilter) {
	          shouldShow = false;
	        }
	
	        if (dangerousFilter !== 'all' && feature.properties.dangerous !== (dangerousFilter === 'true')) {
	          shouldShow = false;
	        }
	
	        if (legalFilter !== 'all' && feature.properties.legal !== (legalFilter === 'true')) {
	          shouldShow = false;
	        }
	
	        layer.setOpacity(shouldShow ? 1 : 0.3);
	      });
	    }
	  });
  </script>
</body>
</html>
